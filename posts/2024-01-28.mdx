---
title: ë¦¬ì•¡íŠ¸ ì¿¼ë¦¬ tkdodo blog ê¸€ ë²ˆì—­
desc: ë¦¬ì•¡íŠ¸ ì¿¼ë¦¬ ê³µì‹ ì‚¬ì´íŠ¸ì— ìˆëŠ” ë¸”ë¡œê·¸ ê¸€ì„ ìŠ¤í„°ë””í•˜ì—¬ ê³µìœ 
date: 2024.01.28
tags: [react query, ë¦¬ì•¡íŠ¸ ì¿¼ë¦¬]
---

Apollo Clientì˜ ë“±ì¥ìœ¼ë¡œ fetch library( ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ë¼ì´ë¸ŒëŸ¬ë¦¬ )ê°€ reduxì™€ ê°™ì€ ì „ì—­ ìƒíƒœê´€ë¦¬ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ëŒ€ì²´í•  ìˆ˜ ìˆë‹¤ëŠ” ì˜ê²¬ì´ í™•ì‚°ë˜ì—ˆë‹¤.

# # 1. ì‹¤ìš©ì  ë¦¬ì•¡íŠ¸ ì¿¼ë¦¬

> í´ë¼ì´ì–¸íŠ¸ ìƒíƒœ VS ì„œë²„ ìƒíƒœ

ApolloëŠ” data fetching ë¿ë§Œ ì•„ë‹ˆë¼ ì„œë²„ì—ì„œ ë³´ë‚¸ ë°ì´í„°( fetchingí•´ì˜¨ ì„œë²„ ë°ì´í„° )ì— ëŒ€í•œ ìºì‹œ ê¸°ëŠ¥ê¹Œì§€ ì œê³µí•œë‹¤. ì¦‰ useQuery hookì„ ì‚¬ìš©í•˜ì—¬ fetchingí•œ í›„ ìºì‹±ëœ ë°ì´í„°ë¥¼ ì—¬ëŸ¬ Componentì—ì„œ ì´ìš©í•  ìˆ˜ ìˆë„ë¡ í•´ì¤€ë‹¤.

ì´ì „ì˜ í´ë¼ì´ì–¸íŠ¸ ì•±ë“¤ì€ ì„œë²„ì˜ ìƒíƒœ( í‘œì‹œí•˜ê³ ì í•˜ëŠ” ë°ì´í„° )ë¥¼ ì†Œìœ í•˜ì§€ ì•Šê³ , ê°€ì¥ ìµœì‹ ì˜ ìë£Œë¥¼ ê°€ì ¸ì™€ì„œ í‘œì¶œí•˜ëŠ”ë° ê·¸ì¹˜ê³  ìˆì—ˆë‹¤. í•­ìƒ ë°ì´í„°ì˜ ì†Œìœ ìëŠ” ì„œë²„ì˜€ë‹¤.

> React-Query

ë¦¬ì•¡íŠ¸ ì¿¼ë¦¬ëŠ” Fronet-endë‹¨ì—ì„œë„ data fetchingê³¼ loading, error stateë¥¼ í¬í•¨í•œ ìƒíƒœ ì „ì—­ì„ ë‹¨ìˆœí•˜ê²Œ ê´€ë¦¬í•˜ë„ë¡ í•˜ê³ ì í–ˆë‹¤. REST apiì²˜ëŸ¼

react-queryëŠ” refetchOnWindowFocusë¥¼ í†µí•´ ë‹¤ë¥¸ ì°½ì— ê°”ë˜ focusê°€ ë‹¤ì‹œ ëŒì•„ì˜¤ë©´ ì„œë²„ì— ë°ì´í„°ë¥¼ ìš”ì²­í•˜ì—¬ ìµœì‹ ìƒíƒœì˜ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤. ì´ë¥¼ í†µí•´ íŠ¸ë¦¬ê±°ëœ Componentì˜ í‘œì¶œëœ ë°ì´í„°ê°€ ë³€ê²½ë˜ë©° ì´ ëª¨ë“  ê³¼ì •ì€ loading spinnerê°€ ì—†ì´ ìë™ìœ¼ë¡œ ì´ë£¨ì–´ì§‘ë‹ˆë‹¤.

1. StaleTime: query dataê°€ ìµœì‹ (fresh) â†’ ì˜¤ë˜ëœ(stale)ìƒíƒœê°€ ë˜ëŠ”ë° ê¹Œì§€ ê±¸ë¦¬ëŠ” ì‹œê°„ì„ ëœ»í•©ë‹ˆë‹¤. ì¿¼ë¦¬ì˜ ë°ì´í„°ê°€ ìµœì‹ ì´ë¼ê³  íŒë‹¨ë  ê²½ìš° í•­ìƒ cacheì— ìˆëŠ” ë°ì´í„°ë§Œì„ í‘œì¶œí•˜ë„ë¡ í•©ë‹ˆë‹¤( ë„¤íŠ¸ì›Œí¬ ìš”ì²­ ì—†ì´ )
2. CacheTime: ë¹„í™œì„± ì¿¼ë¦¬ê°€ ìºì‹œì—ì„œ ì œê±° ë ë•Œê¹Œì§€ì˜ ì‹œê°„ì„ ëœ»í•©ë‹ˆë‹¤(default = 5min). í•´ë‹¹ ì¿¼ë¦¬ì— ë“±ë¡ëœ ê´€ì°°ì(observer)ê°€ ì—†ëŠ” ê²½ìš° ì¦‰ì‹œ ì¿¼ë¦¬ê°€ ë¹„í™œì„± ìƒíƒœê°€ ë©ë‹ˆë‹¤.

â‡’ ëŒ€ë¶€ë¶„ì˜ ê²½ìš° staleTimeì„ ì¡°ì •í•˜ë„ë¡í•˜ê³ , cacheTimeì€ ì¡°ì •í•  í•„ìš”ê°€ ê±°ì˜ ì—†ìŠµë‹ˆë‹¤.

# # 2. ë¦¬ì•¡íŠ¸ ì¿¼ë¦¬ì˜ ë°ì´í„° ë³€í™˜

> ë°ì´í„°ì˜ ë³€í™˜

RESTë¥¼ ì´ìš©í•˜ì—¬ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ë•Œ, í™”ë©´ì— í‘œì¶œí•˜ê¸° ìœ„í•œ í˜•íƒœë¡œ ë°ì´í„°ë¥¼ ê°€ê³µí•  ìˆ˜ ìˆëŠ” ì§€ì ì€ 3 + 1êµ°ë°ê°€ ì¡´ì¬í•œë‹¤.

1. back-end ( +1ì— í•´ë‹¹í•˜ë©° front-endì˜ ë‹´ë‹¹ì´ ì•„ë‹Œ êµ¬ì—­)
   1. ë°±ì—”ë“œë‹¨ì—ì„œ ì• ì´ˆì— í•„ìš”í•œ ë°ì´í„° í˜•íƒœë¡œ ê°€ê³µí•˜ì—¬ ë°ì´í„°ë¥¼ ì „ë‹¬í•´ì£¼ëŠ” ë°©ë²•
   2. ì¥ì 
      1. í‘œì¶œì— ì™„ì „íˆ ë¶€í•©í•˜ëŠ” í˜•íƒœ ê·¸ëŒ€ë¡œ ë°ì´í„°ë¥¼ ë°›ì„ ìˆ˜ ìˆë‹¤.
   3. ë‹¨ì 
      1. í”„ë¡ íŠ¸ì•¤ë“œì˜ ì˜ì—­ì´ ì•„ë‹ˆë‹¤
2. queryFn
   1. useQuery(${QUERY_KEY}, ${queryFn})
      1. ì—¬ê¸°ì„œ queryFnì„ í†µí•´ ë°›ì•„ì˜¨ ë°ì´í„°ë¥¼ ê°€ê³µí•˜ì—¬ cacheì— ì €ì¥í•  ìˆ˜ ìˆë‹¤.
   2. ì¥ì 
      1. ë°ì´í„° ì²˜ë¦¬ ìœ„ì¹˜ê°€ ë°±ì—”ë“œì— ê°€ê¹ë‹¤ ( front-end component â†”Â cache â†”Â back-end )
   3. ë‹¨ì 
      1. fetchingì„ í†µí•´ ë°›ì•„ì˜¨ ë°ì´í„°ë¥¼ queryFnì—ì„œ ê°€ê³µí•˜ì—¬ cacheì— ì €ì¥í•˜ë¯€ë¡œ ì›ë˜ fetchingí•´ì˜¨ ë°ì´í„° ì›í˜•ì„ ë‚˜ì¤‘ì— ë‹¤ì‹œ í™•ì¸í•  ìˆ˜ ì—†ë‹¤.
3. Render
   1. react component renderë‹¨ìœ„ì—ì„œ í•´ë‹¹ ë°ì´í„°ë¥¼ ê°€ê³µí•˜ëŠ” ë°©ë²•
   2. ì¥ì 
      1. useMemoë¥¼ í†µí•´ ìµœì í™”ê°€ ê°€ëŠ¥í•˜ë‹¤.
   3. ë‹¨ì 
      1. ë°ì´í„°ì˜ ì •í™•í•œ êµ¬ì¡°ë¥¼ devtoolsë¥¼ í†µí•´ í™•ì¸í•˜ê¸°ê°€ ì–´ë µë‹¤
      2. êµ¬ë¬¸ì´ ë³µì¡í•˜ë‹¤
4. ì„ íƒ ì˜µì…˜
   1. useQuery( ${QUERY_KEY}, ${queryFn}, ${select_option} )ì—ì„œ select_option ê°ì²´ì—ì„œ selectí”„ë¡œí¼í‹°ì— ë°ì´í„° ì •ì œë¥¼ ì§€ì •í•˜ì—¬ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤.
   2. ì¥ì 
      1. ë°ì´í„°ì˜ ì›í˜•ì„ ì €ì¥í•´ë†“ê³  í•„ìš”ì— ë”°ë¼ ì •ì œí•˜ì—¬ ì“¸ ìˆ˜ ìˆë‹¤
      2. ìœ„ 3ê°€ì§€ ì¤‘ ê°€ì¥ ì¢‹ì€ ë°©ì‹ìœ¼ë¡œ ê³ ë ¤ëœë‹¤.

# # 3. ë¦¬ì•¡íŠ¸ ì¿¼ë¦¬ì˜ ë Œë”ë§ ìµœì í™”

> isFetching ì „í™˜

useQueryë¡œ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ê²½ìš° isFetching ìƒíƒœê°€ true â†’ falseë¡œ ë³€í™˜ë˜ëŠ” ê³¼ì •ì—ì„œ 2ë²ˆì˜ ë Œë”ë§ì„ ê±°ì¹˜ê²Œ ëœë‹¤.

> notifyOnChangeProps: â€˜dataâ€™

ì´ëŸ¬í•œ ë‚­ë¹„ë¥¼ ì¤„ì´ê¸° ìœ„í•´ select option ê°ì²´ì— notifyOnChangeProps í”„ë¡œí¼í‹°ì— â€˜dataâ€™ë¥¼ ê°’ìœ¼ë¡œ ì£¼ì–´ ì‹¤ì œì ìœ¼ë¡œ ë°ì´í„°ê°€ ë³€í™˜ë˜ì—ˆì„ ê²½ìš°ì—ë§Œ ë Œë”ë§ì´ ì¼ì–´ë‚˜ë„ë¡ í•  ìˆ˜ ìˆë‹¤.

> ë™ê¸°í™”ìœ ì§€

ê·¸ëŸ¬ë‚˜ ìœ„ì™€ê°™ì´ dataê°’ë§Œì„ íŠ¸ë¦¬ê±°ë¡œ ë°ì´í„°ì˜ í‘œì¶œì„ í•˜ê²Œ ë  ê²½ìš° í•´ë‹¹ fetchingì´ errorì¼ ê²½ìš°ì— ëŒ€í•œ í‘œì¶œ ì—¬ë¶€ë¥¼ íŠ¸ë¦¬ê±° í•  ìˆ˜ ì—†ë‹¤.

```jsx
// ğŸš¨ will track all fields
const { isLoading, ...queryInfo } = useQuery(...)

// âœ… this is totally fine
const { isLoading
```

```jsx

const queryInfo = useQuery(...)

// ğŸš¨ will not corectly track data
React.useEffect(() => {
    console.log(queryInfo.data)
})

// âœ… fine because the dependency array is accessed during render
React.useEffect(() => {
    console.log(queryInfo.data)
}, [queryInfo.data])
```

> êµ¬ì¡° ê³µìœ 

```jsx
[
  { id: 1, name: 'Learn React', status: 'active' },
  { id: 2, name: 'Learn React Query', status: 'todo' },
];
```

```jsx
[
  -{ id: 1, name: 'Learn React', status: 'active' },
  +{ id: 1, name: 'Learn React', status: 'done' },
  { id: 2, name: 'Learn React Query', status: 'todo' },
];
```

ìœ„ì™€ ê°™ì€ í˜•ì‹ìœ¼ë¡œ todo ë¦¬ìŠ¤íŠ¸ê°€ ìˆì—ˆê³ , ê·¸ ì¤‘ì—ì„œ idê°€ 1ì¸ todoì˜ ë°ì´í„°ê°€ ë³€ê²½ë˜ì—ˆì„ ê²½ìš° react-queryëŠ” ë‚˜ë¨¸ì§€ ë°ì´í„° ( id = 2 )ì˜ ë°ì´í„°ëŠ” ì´ì „ì˜ ì°¸ì¡°ë¥¼ ê·¸ëŒ€ë¡œ ìœ ì§€í•œë‹¤. ë”°ë¼ì„œ idê°€ 2ì¸ todoë¥¼ ì°¸ì¡°í•˜ëŠ” ( ex : select optionì„ ì´ìš©) componentëŠ” idê°€ 1ì¸ todoì˜ ë°ì´í„°ê°€ ë³€ê²½ë˜ì—ˆì–´ì„œ re-renderingë˜ì§€ ì•ŠëŠ”ë‹¤.

í•˜ì§€ë§Œ í•´ë‹¹ query-keyì— ì €ì¥ëœ ë°ì´í„°ê°€ ì•„ì£¼ í´ ê²½ìš° JSON ì§ë ¬í™”ë¥¼ í†µí•´ queryFnìœ¼ë¡œ ë³€í˜•ëœ ë°ì´í„°ê°€ ì´ì „ì˜ ë°ì´í„°ì™€ ë³€ê²½ì‚¬í•­ì´ ìˆëŠ”ì§€ íŒŒì•…í•´ì•¼ í•˜ê¸° ë•Œë¬¸ì— ë³‘ëª©í˜„ìƒì´ ìƒê¸¸ ìˆ˜ ìˆë‹¤.

ë”°ë¼ì„œ ì´ëŸ¬í•œ ìµœì í™”ê°€ í•„ìš”í•˜ì§€ ì•Šë‹¤ë©´ ( ë°›ì•„ì˜¨ ë°ì´í„°ê°€ ì‹¤ì œë¡œ ë³€ê²½ëœ ë¶€ë¶„ë§Œ êµì²´í•˜ë„ë¡ í•˜ì—¬ ë³€ê²½ë˜ì§€ ì•Šì€ ë°ì´í„°ë¥¼ ì°¸ì¡°í•˜ê³  ìˆëŠ” componentë“¤ì˜ re-renderingì„ ë°©ì§€í•˜ëŠ” ìµœì í™” ) structureSharing: falseë¥¼ í†µí•´ ëŒ ìˆ˜ ìˆë‹¤.

# #4. React-query ìƒíƒœ í™•ì¸

ë¦¬ì•¡íŠ¸ ì¿¼ë¦¬ëŠ” ì¿¼ë¦¬ì˜ ìƒíƒœ í•„ë“œì— ì‰½ê²Œ access í•  ìˆ˜ ìˆë„ë¡ í•´ì¤€ë‹¤. ë”°ë¼ì„œ í˜„ì¬ ì‹¤í–‰ì¤‘ì¸ queryê°€ ì–´ë–¤ ìƒíƒœì¸ì§€( ë¡œë”©, ì—ëŸ¬, íŒ¨ì¹­ ë“± ) ì‰½ê²Œ íŒŒì•…ì´ ëœë‹¤. react-queryì—ì„œ ë…¸ì¶œí•´ì£¼ëŠ” í”Œë˜ê·¸ê°’ëŠ” ë‹¤ìŒê³¼ ê°™ë‹¤.

- success: ì¿¼ë¦¬ê°€ ì„±ê³µí–ˆìœ¼ë©°, ë°ì´í„°ê°€ ìˆìŒ.
- error: ì¿¼ë¦¬ê°€ ì‹¤íŒ¨ í–ˆìœ¼ë©°, ì˜¤ë¥˜ê°€ ì„¤ì •ë˜ì—ˆìŒ.
- loading: ì¿¼ë¦¬ë¥¼ ì²˜ìŒìœ¼ë¡œ ë¡œë“œì¤‘ì´ë©°, í˜„ì¬ ë°ì´í„°ê°€ ì—†ìŒ.
- idle: ì¿¼ë¦¬ ë¹„í™œì„± ìƒíƒœ ( ë¡œë“œ ëœ ì  ì—†ìŒ )

```jsx
const todos = useTodos();

if (todos.isLoading) {
  return 'Loading...';
}
if (todos.error) {
  return 'An error has occurred: ' + todos.error.message;
}

return <div>{todos.data.map(renderTodo)}</div>;
```

ë¦¬ì•¡íŠ¸ ì¿¼ë¦¬ì—ì„  re-fetching ë©”ì»¤ë‹ˆì¦˜ì´ ì—†ì§€ë§Œ, ë¦¬ì•¡íŠ¸ ì¿¼ë¦¬ì—ì„  refetchOnMount, refetchOnWindowFocus, refetchOnReconnetì˜ ê°œë…ì„ ì œê³µí•˜ì—¬ ë°ì´í„° refetchë¥¼ ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì‹¤í–‰í•  ìˆ˜ ìˆë„ë¡í•´ì¤ë‹ˆë‹¤. ( ê·¸ëŸ¬ë‚˜ ë°±ê·¸ë¼ìš´ë“œ refetchì˜ ì‹¤íŒ¨ì‹œ í˜¼ë€ìŠ¤ëŸ¬ìš´ uxê°€ ë°œìƒí•  ê°€ëŠ¥ì„±ì´ ìˆë‹¤. )

> ë°±ê·¸ë¼ìš´ë“œ ì˜¤ë¥˜

```jsx
{
  "status": "error",
  "error": { "message": "Something went wrong" },
  "data": [{ ... }]
}
```

fetchê°€ ì‹¤íŒ¨í•œ ì¿¼ë¦¬ì˜ ë°ì´í„° ìƒíƒœëŠ” ë‹¤ìŒê³¼ ê°™ì„ ìˆ˜ ìˆë‹¤. ìœ„ì™€ê°™ì´ fetchê°€ ì‹¤íŒ¨í•˜ì˜€ìŒì—ë„, ì´ì „ì— ê°€ì§€ê³  ìˆë˜ dataëŠ” ì‚­ì œë˜ì§€ ì•Šê³  ê°€ì§€ê³  ìˆì„ ìˆ˜ ìˆìœ¼ë©°, stale-while-revalidate ìºì‹± ë©”ì»¤ë‹ˆì¦˜ì„ ìˆ˜ìš©í•œ ê²°ê³¼ë¡œ ë³¼ ìˆ˜ ìˆë‹¤. (re-fetchì‘ì—…ì€ defaultë¡œ 3ë²ˆê¹Œì§€ ì‹¤í–‰ëœë‹¤.)

# #5. React-query í…ŒìŠ¤íŠ¸í•˜ê¸°

# #6. React-Query & TypeScript

```jsx
export function useQuery<
  TQueryFnData = unknown,
  TError = unknown,
  TData = TQueryFnData,
  TQueryKey extends QueryKey = QueryKey
>
```

> ë„¤ê°€ì§€ generic

- TQueryFnData: queryFnì—ì„œ ë°˜í™˜ëœ ìœ í˜•.
- TError: queryFnì—ì„œ ì˜ˆìƒë˜ëŠ” ì˜¤ë¥˜ ìœ í˜•
- TData: ë°ì´í„° ì†ì„±. (queryFnì—ì„œ ë°˜í™˜í•˜ëŠ” ë°ì´í„° ìœ í˜•ê³¼ ë‹¤ë¥¼ ìˆ˜ ìˆìŒ)
- TQueryKey: queryFnì— ì „ë‹¬ëœ queryKeyë¥¼ ì‚¬ìš©í•˜ëŠ” ê²½ìš°ì—ë§Œ ì‚¬ìš©í•˜ëŠ” ìœ í˜•

> íƒ€ì… ì¶”ë¡ 

```jsx
function identity<T>(value: T): T {
  return value;
}

// ğŸš¨ no need to provide the generic
let result = identity < number > 23;

// âš ï¸ or to annotate the result
let result: number = identity(23);

// ğŸ˜ infers correctly to `string`
let result = identity('react-query');
```

>

> ë¶€ë¶„ íƒ€ì… ì¸ìˆ˜ ì¶”ë¡ 

```jsx
function useGroupCount() {
  return useQuery<Group[], Error>('groups', fetchGroups, {
    select: (groups) => groups.length,
    // ğŸš¨ Type '(groups: Group[]) => number' is not assignable to type '(data: Group[]) => Group[]'.
    // Type 'number' is not assignable to type 'Group[]'.ts(2322)
  })
}
```

```jsx
function useGroupCount() {
  // âœ… fixed it
  return useQuery<Group[], Error, number>('groups', fetchGroups, {
    select: (groups) => groups.length,
  })
}
```

ìœ„ì˜ ê²½ìš° useQueryì—ì„œ selectì— ëŒ€í•œ typeì„ ì§€ì •í•´ì£¼ì§€ ì•Šì•˜ê¸° ë•Œë¬¸ì— íƒ€ì…ì„ ì¶”ë¡ í•  ìˆ˜ ì—†ë‹¤.

ì•„ë˜ì˜ ê²½ìš° numberë¡œ selectë¶€ì˜ íƒ€ì…ì„ ì„ ì–¸í•´ì£¼ì—ˆê¸° ë•Œë¬¸ì— í•´ë‹¹ íƒ€ì…ìœ¼ë¡œ ì´ìš©ì´ ëœë‹¤.

> ëª¨ë“ ê²ƒì„ ì¶”ë¡ 

```jsx
function useGroups() {
  // ğŸš¨ data will be `any` here
  return useQuery('groups', () =>
    axios.get('groups').then((response) => response.data)
  );
}
```

ë§Œì•½ ìœ„ì™€ê°™ì´ axiosì˜ ë°˜í™˜ê°’ì„ ê·¸ëŒ€ë¡œ useQueryì—ì„œ ì´ìš©í•˜ê²Œ ëœë‹¤ë©´, íƒ€ì…ì„ ì¶”ë¡ í•  ìˆ˜ ì—†ê³  fetch libraryì—ì„œ ì œê³µí•˜ëŠ” íƒ€ì…ì„ ê·¸ëŒ€ë¡œ ì¸ìš©í•˜ê²Œ ëœë‹¤. ë”°ë¼ì„œ íƒ€ì…ì„ ìœ ì¶”í•  ìˆ˜ ìˆë„ë¡ ì¤‘ê°„ layer functionì„ ì‘ì„±í•˜ì—¬ ì´ìš©í•˜ëŠ” ë°©ë²•ì„ ì“°ëŠ”ê²Œ ì¢‹ë‹¤.

```jsx
function fetchGroups(): Promise<Group[]> {
  return axios.get('groups').then((response) => response.data);
}

// âœ… data will be `Group[] | undefined` here
function useGroups() {
  return useQuery('groups', fetchGroups);
}

// âœ… data will be `number | undefined` here
function useGroupCount() {
  return useQuery('groups', fetchGroups, {
    select: (groups) => groups.length,
  });
}
```

> íƒ€ì… ì¶•ì†Œ

```jsx
const { data, isSuccess } = useGroups();
if (isSuccess) {
  // ğŸš¨ data will still be `Group[] | undefined` here
}

const groupsQuery = useGroups();
if (groupsQuery.isSuccess) {
  // âœ… groupsQuery.data will now be `Group[]`
}
```

ìœ„ì˜ ë°©ì‹ì²˜ëŸ¼ destructuringì„ ì‚¬ìš©í•˜ê²Œ ë˜ë©´ typeì¶”ë¡ ì—ì„œ undefinedê°€ ì¶”ê°€ë  ìˆ˜ ìˆë‹¤. ë”°ë¼ì„œ êµ¬ì¡°ë¶„í•´í• ë‹¹ë³´ë‹¨ ê°ì²´ë¥¼ ê·¸ëŒ€ë¡œ ê°€ì ¸ì™€ì„œ chaningì„ ì´ìš©í•˜ì—¬ ì´ìš©í•˜ëŠ”ê²ƒì´ íƒ€ì…ì˜ ë²”ìœ„ë¥¼ ì¶•ì†Œí•  ìˆ˜ ìˆëŠ” ì¢‹ì€ ë°©ë²•ì´ë‹¤.

# #8. íš¨ê³¼ì ì¸ React-Query key

ë¦¬ì•¡íŠ¸ì¿¼ë¦¬ì—ì„œ í‚¤ëŠ” ì¤‘ìš” í•µì‹¬ê°œë…ìœ¼ë¡œ, ë¼ì´ë¸ŒëŸ¬ë¦¬ ë‚´ë¶€ì ìœ¼ë¡œ ë°ì´í„°ë¥¼ ìºì‹œí•˜ê³ , re-fetchë¥¼ í•˜ê¸° ìœ„í•´ í•„ìš”í•œ ê°œë…ì´ë‹¤.

> ë°ì´í„° ìºì‹±

ì¿¼ë¦¬ ìºì‹œëŠ” ì§ë ¬í™”ëœ ì¿¼ë¦¬í‚¤ë¥¼ í‚¤ë¡œ í•˜ê³ , ë°ì´í„°ì™€ ë§¤í„°ì •ë³´ë¥¼ ê°–ëŠ” javascript objectë¥¼ valueë¡œ ê°–ë„ë¡ í•œë‹¤.

ì´ë•Œ, query keyëŠ” ê³ ìœ í•´ì•¼ í•˜ê³ , useQuery â†”Â useInfiniteQueryì— ë™ì¼í•œ ì¿¼ë¦¬í‚¤ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ë‹¤.

```jsx
useQuery(['todos'], fetchTodos);

// ğŸš¨ this won't work
useInfiniteQuery(['todos'], fetchInfiniteTodos);

// âœ… choose something else instead
useInfiniteQuery(['infiniteTodos'], fetchInfiniteTodos);
```

> ìë™ ë‹¤ì‹œ ê°€ì ¸ì˜¤ê¸°

```jsx
function Component() {
  const { data, refetch } = useQuery(['todos'], fetchTodos)

  // â“ how do I pass parameters to refetch â“
  return <Filters onApply={() => refetch(???)} />
}
```

ìœ„ì˜ ì½”ë“œë¥¼ ë³´ë©´ finterì—ì„œ í•„í„°ê°€ selectë˜ì–´ applyë˜ëŠ” ì‹œì ì— todosë¥¼ í•´ë‹¹ í•„í„°ì— ë§ëŠ” ê²ƒë“¤ë§Œ í•„í„°ë§í•˜ì—¬ ê°€ì ¸ì˜¤ê¸¸ ì›í•œë‹¤.

ê·¸ëŸ¬ë‚˜ applyì— refetchë¥¼ í•˜ë„ë¡ í•˜ëŠ” ë°©ì‹ì€ ì ì ˆí•˜ì§€ ì•Šë‹¤. todosì— í•´ë‹¹í•˜ëŠ” cacheê°’ì€ ì´ì „ê³¼ ì–¸ì œë‚˜ ë™ì¼í•˜ê²Œ ìˆì„í…Œë‹ˆê¹. (query keyê°’ì€ ê·¸ëŒ€ë¡œì´ë¯€ë¡œ)

ë”°ë¼ì„œ ì•„ë˜ì™€ ê°™ì´ ë³€ê²½í•´ì•¼ í•œë‹¤.

```jsx
function Component() {
  const [filters, setFilters] = React.useState();
  const { data } = useQuery(['todos', filters], () => fetchTodos(filters));

  // âœ… set local state and let it "drive" the query
  return <Filters onApply={setFilters} />;
}
```

> ìˆ˜ë™ ìƒí˜¸ ì‘ìš©

ì¿¼ë¦¬ìºì‹œì— ëŒ€í•œ ìˆ˜ë™ì ì¸ ìƒí˜¸ì‘ìš©ì„ ì´ìš©í•˜ê¸° ìœ„í•´ì„  invalidateQueries, setQueriesDataë¥¼ í™œìš©í•  ìˆ˜ ìˆë‹¤. ì´ë•Œ, query filterë¥¼ ì§€ì›í•˜ê¸° ë•Œë¬¸ì— filter ê°ì²´ì— ëª…ì‹œí•œ ì¡°ê±´ì— í•´ë‹¹í•˜ëŠ” ì¿¼ë¦¬ë“¤ì— ê´€í•˜ì—¬ ìƒí˜¸ì‘ìš©í•˜ë„ë¡ ì»¨íŠ¸ë¡¤ í•  ìˆ˜ ìˆë‹¤.

> íš¨ê³¼ì ì¸ ì¿¼ë¦¬ í‚¤

- ë„ë©”ì¸ ë³„ë¡œ queries.tsë¡œ íŒŒì¼ ê´€ë¦¬í•˜ë„ë¡ í•œë‹¤.
- ì¿¼ë¦¬í‚¤ëŠ” í•­ìƒ ë°°ì—´ë¡œ ë§Œë“ ë‹¤
- ì¿¼ë¦¬í‚¤ ë°°ì—´ì€ ì¼ë°˜ì ì¸ê²ƒ â†’ êµ¬ì²´ì ì¸ê²ƒ ìˆœì„œë¡œ êµ¬ì²´í™”í•˜ì—¬ êµ¬ì¡°í™” í•œë‹¤.
- ## ì¿¼ë¦¬ í‚¤ íŒ©í† ë¦¬ ì‚¬ìš©
  ```jsx
  const todoKeys = {
    all: ['todos'] as const,
    lists: () => [...todoKeys.all, 'list'] as const,
    list: (filters: string) => [...todoKeys.lists(), { filters }] as const,
    details: () => [...todoKeys.all, 'detail'] as const,
    detail: (id: number) => [...todoKeys.details(), id] as const,
  }
  ```

> QueryFunctionContext

ìœ„ì˜ todoKeysë¥¼ ë³´ë©´ ì¿¼ë¦¬í‚¤ë¥¼ ë°°ì—´ë¡œ ì‘ì„±í–ˆë‹¤. ì´ë•Œ QueryFunctionContextë¥¼ ì´ìš©í•˜ë©´ ì…ë ¥ëœ queryKeyë¥¼ êµ¬ì¡°ë¶„í•´ í• ë‹¹ì‹œ

```jsx
const todoKeys = {
  all: ['todos'] as const,
  lists: () => [...todoKeys.all, 'list'] as const,
  list: (state: State, sorting: Sorting) =>
    [...todoKeys.lists(), state, sorting] as const,
}

const fetchTodos = async ({
  queryKey,
}: // ğŸ¤¯ only accept keys that come from the factory
QueryFunctionContext<ReturnType<typeof todoKeys['list']>>) => {
  const [, , state, sorting] = queryKey
  const response = await axios.get(`todos/${state}?sorting=${sorting}`)
  return response.data
}

export const useTodos = () => {
  const { state, sorting } = useTodoParams()

  // âœ… build the key via the factory
  return useQuery(todoKeys.list(state, sorting), fetchTodos)
}
```

ì½¤ë§ˆë¥¼ ì´ìš©í•˜ì—¬ ë¶ˆë¶„ëª…í•˜ê²Œ êµ¬ë¶„í•´ì•¼ë§Œ í•œë‹¤.

ë”°ë¼ì„œ ì´ëŸ¬í•œ ë¬¸ì œì ì„ í•´ê²°í•˜ê¸° ìœ„í•´ ì¿¼ë¦¬í‚¤ë¥¼ ê°ì²´ í˜•íƒœë¡œ ë§Œë“¤ì–´ ì‚¬ìš©í•˜ë„ë¡ í•˜ëŠ” ë°©ë²•ì´ ì¢‹ë‹¤.

```jsx
const todoKeys = {
  // âœ… all keys are arrays with exactly one object
  all: [{ scope: 'todos' }] as const,
  lists: () => [{ ...todoKeys.all[0], entity: 'list' }] as const,
  list: (state: State, sorting: Sorting) =>
    [{ ...todoKeys.lists()[0], state, sorting }] as const,
}

const fetchTodos = async ({
  // âœ… extract named properties from the queryKey
  queryKey: [{ state, sorting }],
}: QueryFunctionContext<ReturnType<typeof todoKeys['list']>>) => {
  const response = await axios.get(`todos/${state}?sorting=${sorting}`)
  return response.data
}

export const useTodos = () => {
  const { state, sorting } = useTodoParams()

  return useQuery(todoKeys.list(state, sorting), fetchTodos)
}
```

# #9. ë¦¬ì•¡íŠ¸ ì¿¼ë¦¬ì˜ placeholder ë° init data

ë¦¬ì•¡íŠ¸ ì¿¼ë¦¬ì—ì„œ ë™ê¸°ì‹ìœ¼ë¡œ ë¯¸ë¦¬ ê°’ì„ ì±„ìš°ëŠ” ë°©ì‹ìœ¼ë¡œ ë‘ê°€ì§€ë¥¼ ì œê³µí•œë‹¤.

- placeholder
- initial data

> ìœ ì‚¬ì 

```jsx
function Component() {
  // âœ… status will be success even if we have not yet fetched data
  const { data, status } = useQuery(['number'], fetchNumber, {
    placeholderData: 23,
  });

  // âœ… same goes for initialData
  const { data, status } = useQuery(['number'], fetchNumber, {
    initialData: () => 42,
  });
}
```

ë‘ê°€ì§€ ëª¨ë‘ ìºì‹œì— í•´ë‹¹ ì¿¼ë¦¬í‚¤ë¡œ ê°’ì´ ì €ì¥ë˜ì–´ìˆë‹¤ë©´, ì•„ë¬´ëŸ° ì—­í• ì„ í•˜ì§€ ëª»í•œë‹¤.

> ì°¨ì´ì 

- initialData: cacheìˆ˜ì¤€ì—ì„œ ì‘ë™
  - cacheì— ê°’ì´ ì €ì¥ëœë‹¤.
  - cacheí•­ëª©ì˜ ìƒì„± ìˆœê°„( ì²«ë²ˆì§¸ observerê°€ mountë˜ëŠ” ì‹œì  )ì— ê°’ì´ ì €ì¥ëœë‹¤.
- placeholder: observerìˆ˜ì¤€ì—ì„œ ì‘ë™
  - cacheì— ì €ì¥ë˜ì§€ ì•ŠëŠ”ë‹¤.
  - ë”°ë¼ì„œ componentë§ˆë‹¤ placeholderì— ëŒ€í•œ ê°’ì´ ë‹¤ë¥¼ ìˆ˜ ìˆë‹¤

> ì—ëŸ¬ ì²˜ë¦¬

background re-fetchê°€ ì‹¤íŒ¨í–ˆì„ ì‹œ

- initialData
  - ìºì‹œì—” ì´ë¯¸ initialDataê°€ ì¡´ë°°í•˜ë¯€ë¡œ ë‹¤ë¥¸ background ì˜¤ë¥˜ì™€ ê°™ì´ ì²˜ë¦¬í•˜ë©´ ëœë‹¤.
- placeholder
  - cacheì— ë°ì´í„°ê°€ ì ì¬ë˜ë ¤ê³  í•˜ëŠ” ìˆœê°„ ì˜¤ë¥˜ì´ë¯€ë¡œ placeholderëŠ” ì‚¬ë¼ì§€ê³  cacheì—” undefinedê°€ ì €ì¥ëœë‹¤.

# 10. ìƒíƒœê´€ë¦¬ìë¡œì„œ react query

> ë¹„ë™ê¸° ìƒíƒœ ê´€ë¦¬ì

QueryClientProvider í•˜ìœ„ì— ì¡´ì¬í•˜ëŠ” ëª¨ë“  componentì—ì„  queryClientë¥¼ í†µí•´ í‘œì¶œí•˜ëŠ” ëª¨ë“  ë°ì´í„°ëŠ” observerë¡œì„œ ê´€ì°°ì´ ê°€ëŠ¥í•˜ê²Œ ë˜ë©° í•´ë‹¹ ê°’ì˜ ë³€ê²½ì„ ìë™ìœ¼ë¡œ ê°ì§€í•˜ì—¬ renderingí•˜ê²Œ ë˜ë¯€ë¡œ, ë¹„ë™ê¸° ìƒíƒœë¡œ ë°ì´í„°ë¥¼ ê´€ë¦¬í•˜ì—¬ í‘œì¶œ ê°€ëŠ¥í•˜ë‹¤.

> ë°ì´í„° ë™ê¸°í™” ë„êµ¬

ë¦¬ì•¡íŠ¸ ì¿¼ë¦¬ì˜ cacheë°ì´í„°ë¥¼ êµ¬ë…í•˜ëŠ” componentë“¤ì€ cacheì— ì €ì¥ëœ snapshotì„±ê²©ì˜ ë°ì´í„°ë¥¼ í‘œì‹œë§Œ í•˜ëŠ”ê²ƒì´ë‹¤. ë”°ë¼ì„œ í•´ë‹¹ ë°ì´í„°ê°€ stale í•œì§€ freshí•œì§€ íŒë³„í•˜ì—¬ cacheì— ì €ì¥ëœ snapshot ë°ì´í„°ê°€ back-endì™€ ë™ê¸°í™”ë˜ë„ë¡ ì„¤ì •í•  ìˆ˜ ìˆë‹¤.

- ë¦¬ì•¡íŠ¸ ì¿¼ë¦¬ ì´ì „ì˜ ë°ì´í„° ë™ê¸°í™”
  - ê°€ì ¸ì˜¨ í›„ globalë¡œ ì €ì¥í•˜ê³ , ì—…ë°ì´íŠ¸ í•˜ì§€ ì•ŠëŠ”ë‹¤.
- mountì‹œë§ˆë‹¤ ê°€ì ¸ì˜¤ê³  component localì— í•œì •
  - useEffect(()â‡’{}, []) ì„ í†µí•´ ê°€ì ¸ì˜¨ ë°ì´í„°ë¥¼ component localì—ì„œ ì´ìš©í•œë‹¤.

> ë°ì´í„° ì¬ê²€ì¦( ì„œë²„ì™€ ë™ê¸°í™” ) í•˜ëŠ”ë™ì•ˆ stale data í‘œì¶œ

ë°ì´í„°ë¥¼ ì„œë²„ë¡œë¶€í„° ìƒˆë¡œ ê°€ì ¸ì˜¤ëŠ” ê³¼ì •ì€ ì‹œê°„ì´ ê±¸ë¦¬ê³ , í™”ë©´ì—ì„  í•­ìƒ loading bar || spinnerê°€ í‘œì¶œë˜ì–´ì•¼ë§Œ í•œë‹¤. ì´ê²ƒì€ ì‚¬ìš©ì ê´€ì ì—ì„œ â€œëŠë¦¬ë‹¤"ëŠ” ëŠë‚Œì„ ë°›ê²Œ í•˜ë¯€ë¡œ, fresh ë°ì´í„°ê°€ í‘œì¶œë˜ê¸° ì „ì— staleë°ì´í„°ê°€ ë¨¼ì € í‘œì¶œë˜ëŠ”ê²ƒì´ ë‚˜ì„ ìˆ˜ ìˆë‹¤.

> smart re-fetch

- refetchOnMount
  - mountì‹œë§ˆë‹¤ ì¬ê²€ì¦í•œë‹¤.
- refetchOnWindowFocus
  - ë¸Œë¼ìš°ì €íƒ­ì— í¬ì»¤ìŠ¤ë¥¼ í•  ë•Œë§ˆë‹¤ re-fetchí•œë‹¤. ì´ê²Œ ë„ˆë¬´ ë§ë‹¤ê³  ëŠë‚„ ìˆ˜ ìˆìœ¼ë‚˜, ì‚¬ìš©ì ê´€ì ì—ì„œ ë‹¤ë¥¸íƒ­ì— í¬ì»¤ì‹±ì„ í–ˆë‹¤ í•´ë‹¹ íƒ­ìœ¼ë¡œ ëŒì•„ì™”ì„ë•Œ freshë°ì´í„°ë¥¼ í‘œì¶œí•´ì£¼ëŠ”ê²ƒì€ ì‚¬ìš©ìì—ê²Œ ìµœì‹ ì˜ ë°ì´í„°ë¥¼ í‘œì‹œí•˜ëŠ” ì™„ë²½í•œ ë°©ë²•ì´ë‹¤.
- refetchOnReconnect
  - ë„¤íŠ¸ì›Œí¬ ì—°ê²° ì¢…ë£Œ í›„ freshê°’ì„ í‘œì¶œí•´ì£¼ëŠ”ê²ƒ ë˜í•œ í™”ë©´ì˜ ê°’ì´ ì •í™•í•œì§€ ì—¬ë¶€ë¥¼ ë‹¤ì‹œ í™•ì¸í•  ë•Œ ì¢‹ì€ ì§€í‘œê°€ ë  ìˆ˜ ìˆë‹¤.

ë§Œì•½ cacheë°ì´í„°ë¥¼ ë°”ë¼ë³´ëŠ” componentë¥¼ ë‹¤ë¥¸ componentì˜ í•˜ìœ„ componentë¡œ ë„£ì„ ê²½ìš° refetchOnMountë¥¼ ì¼œë†“ê²Œ ë˜ë©´ ìƒìœ„ ì»´í¬ë„ŒíŠ¸ ë Œë”ë§ë§ˆë‹¤ í•˜ìœ„ ì»´í¬ë„ŒíŠ¸ì˜ ë°ì´í„°ë¥¼ ê³„ì†í•´ì„œ re-fetchí•˜ê¸° ë•Œë¬¸ì— refetchOnMountë¥¼ ë„ëŠ”ê²Œ ì¢‹ì„ ìˆ˜ ìˆë‹¤.

> staleTime ì‚¬ìš©ì ì§€ì •

ìµœì‹ ê°’ì„ í‘œì¶œí•˜ê¸° ìœ„í•œ ëª©ì ìœ¼ë¡œ ì¤‘ë³µìš”ì²­ì„ ì œê±°í•˜ê¸° ìœ„í•´ ìµœì†Œ 20ì´ˆ ì •ë„ë¡œ ì„¤ì •í•˜ëŠ”ê²Œ ì¢‹ì€ ì„ íƒì¼ ìˆ˜ ìˆë‹¤.

ì´ëŸ¬í•œ ì„¤ì •ë“¤ì„ ì¡ê¸°ìœ„í•´ setQueryDefaultsë¥¼ ì´ìš©í•´ queryKeyë“¤ì˜ ê¸°ë³¸ì„¤ì •ì„ ì§€ì •í•  ìˆ˜ ìˆë‹¤.
